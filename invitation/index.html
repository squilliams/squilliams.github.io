<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Wedding Invitations (TSV with Newlines)</title>
  <style>
    /* 
      1. Full-page blue gradient background
      2. White container with slight transparency
      3. Elegant fonts and spacing
    */
    body {
      margin: 0;
      padding: 0;
      font-family: "Open Sans", sans-serif;
      background: linear-gradient(to right, #6190E8, #A7BFE8);
      /* Fallback color if gradient not supported */
      background-color: #6190E8;
    }
    .container {
      max-width: 800px;
      margin: 2rem auto;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    }

    h1 {
      text-align: center;
      color: #333;
    }

    /* Form controls for search/filter */
    .filters {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .filters label {
      font-weight: 600;
      color: #333;
    }
    .filters input[type="text"],
    .filters select {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Invitation card styling */
    .invitation {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: #f8f8f8;
    }

    .invite-name {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #333;
    }

    /* Preserve newlines in the message */
    .invitation-message {
      white-space: pre-wrap;   /* important to keep line breaks */
      word-wrap: break-word;
      margin-bottom: 1rem;
      color: #555;
      font-family: inherit;    /* keep consistent font */
    }

    .copy-btn {
      background-color: #6190E8;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    .copy-btn:hover {
      background-color: #5178c8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Wedding Invitations</h1>

    <!-- Filters Section -->
    <div class="filters">
      <label for="searchBox">Search by name:</label>
      <input
        id="searchBox"
        type="text"
        placeholder="Type a name..."
        oninput="handleSearchAndFilter()"
      />

      <label for="groupSelect">Filter by group:</label>
      <select id="groupSelect" onchange="handleSearchAndFilter()">
        <!-- We'll populate this dynamically -->
      </select>
    </div>

    <!-- Container for invitations -->
    <div id="invitationsContainer">
      <!-- The script will inject invitation cards here -->
    </div>
  </div>

  <script>
    /**
     * 1. Your TSV URLs (one or more) go here.
     *    Make sure each sheet is published with output=tsv and includes your columns:
     *    Name, Group, Invitation Message, etc.
     */
    const TSV_URLS = [
      // Example:
      // "https://docs.google.com/spreadsheets/d/XXXXXX/pub?gid=111111&single=true&output=tsv"
      // "https://docs.google.com/spreadsheets/d/XXXXXX/pub?gid=222222&single=true&output=tsv"
      // Add your actual published TSV links below:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKiNwsIyFlBBHT6uGx696qXIO2iWnBgVl1-mfrDFNAu7oJnVJfLkjeaAeU6ZfCt5N4YHYJgVd8hCkf/pub?gid=1512406102&single=true&output=tsv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKiNwsIyFlBBHT6uGx696qXIO2iWnBgVl1-mfrDFNAu7oJnVJfLkjeaAeU6ZfCt5N4YHYJgVd8hCkf/pub?gid=61925263&single=true&output=tsv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKiNwsIyFlBBHT6uGx696qXIO2iWnBgVl1-mfrDFNAu7oJnVJfLkjeaAeU6ZfCt5N4YHYJgVd8hCkf/pub?gid=1674697729&single=true&output=tsv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKiNwsIyFlBBHT6uGx696qXIO2iWnBgVl1-mfrDFNAu7oJnVJfLkjeaAeU6ZfCt5N4YHYJgVd8hCkf/pub?gid=766178584&single=true&output=tsv"    
    ];

    // 2. We'll store all data (from all TSVs) here
    let allInvitations = [];

    // On page load, fetch all TSVs
    window.addEventListener("DOMContentLoaded", () => {
      fetchAllTSVs();
    });

    async function fetchAllTSVs() {
      try {
        // Fetch each URL in parallel
        const fetchPromises = TSV_URLS.map(url => {
          return fetch(url)
            .then(res => res.text())
            .then(tsvText => parseTSV(tsvText));
        });

        // Wait for all fetches
        const arrayOfArrays = await Promise.all(fetchPromises);
        // Flatten the results into one array
        allInvitations = arrayOfArrays.flat();

        // Populate the group dropdown
        populateGroupDropdown(allInvitations);

        // Render everything by default (i.e., show all invitations)
        renderInvitations(allInvitations);
      } catch (error) {
        console.error("Error fetching/parsing TSVs:", error);
      }
    }

    /**
     * Basic TSV parser that expects columns:
     *   Name, Unique Code (optional), Group, Invitation Message
     */
    function parseTSV(tsvText) {
      const lines = tsvText.trim().split("\n");
      // Split the first line by tab to get header names
      const headers = lines[0].split("\t");

      // Find relevant column indices
      const nameIndex = headers.indexOf("name");
      const codeIndex = headers.indexOf("invitation_code"); // optional if you have it
      const groupIndex = headers.indexOf("group");
      const messageIndex = headers.indexOf("invitation_message");

      // Slice off the header row and parse each line
      const data = lines.slice(1).map(line => {
        const fields = line.split("\t"); // split by tab
        return {
          name: fields[nameIndex] || "",
          code: codeIndex >= 0 ? (fields[codeIndex] || "") : "",
          group: fields[groupIndex] || "",
          message: fields[messageIndex] || ""
        };
      });
      return data;
    }

    /**
     * Create group dropdown options (including "All Groups").
     */
    function populateGroupDropdown(dataArray) {
      const groupSelect = document.getElementById("groupSelect");

      // Gather unique group names
      const uniqueGroups = [...new Set(dataArray.map(item => item.group))].sort();

      // Clear existing
      groupSelect.innerHTML = "";

      // "All Groups" option
      const allOption = document.createElement("option");
      allOption.value = "";
      allOption.textContent = "All Groups";
      groupSelect.appendChild(allOption);

      // One option per group
      uniqueGroups.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        groupSelect.appendChild(opt);
      });
    }

    /**
     * Handle search (by name) and filter (by group) together.
     */
    function handleSearchAndFilter() {
      const searchQuery = document.getElementById("searchBox").value.toLowerCase();
      const selectedGroup = document.getElementById("groupSelect").value;

      // Filter by name and group
      const filtered = allInvitations.filter(item => {
        const matchesName = item.name.toLowerCase().includes(searchQuery);
        const matchesGroup = selectedGroup === "" || item.group === selectedGroup;
        return matchesName && matchesGroup;
      });

      renderInvitations(filtered);
    }

    /**
     * Render the invitations into the invitationsContainer.
     */
    function renderInvitations(dataArray) {
      const container = document.getElementById("invitationsContainer");
      container.innerHTML = ""; // clear existing

      // For each item, build an "invitation card"
      dataArray.forEach(item => {
        const invitationDiv = document.createElement("div");
        invitationDiv.classList.add("invitation");

        // Name (plus group in parentheses)
        const nameEl = document.createElement("div");
        nameEl.classList.add("invite-name");
        nameEl.textContent = item.group
          ? `${item.name} (${item.group})`
          : `${item.name}`;

        // Message (preserve line breaks)
        const msgEl = document.createElement("pre");
        msgEl.classList.add("invitation-message");
        msgEl.textContent = item.message;

        // Copy button
        const copyBtn = document.createElement("button");
        copyBtn.classList.add("copy-btn");
        copyBtn.textContent = "Copy Message";
        copyBtn.addEventListener("click", () => {
          copyToClipboard(item.message);
        });

        // Append elements
        invitationDiv.appendChild(nameEl);
        invitationDiv.appendChild(msgEl);
        invitationDiv.appendChild(copyBtn);
        container.appendChild(invitationDiv);
      });
    }

    /**
     * Copies text (with newlines) to the clipboard.
     */
    function copyToClipboard(text) {
      // This should preserve newlines as long as they exist in "text"
      navigator.clipboard.writeText(text)
        .then(() => alert("Copied with line breaks!"))
        .catch(err => console.error("Failed to copy:", err));
    }
  </script>
</body>
</html>
